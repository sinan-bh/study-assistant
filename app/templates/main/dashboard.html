{% extends 'base.html' %}

{% block content %}
  <!-- Header -->
  <div class="flex justify-between items-center mb-8">
    <h1 class="text-3xl font-bold text-gray-900"><i class="fas fa-tachometer-alt mr-3 text-blue-600"></i>Dashboard</h1>
    <div class="text-gray-600">Welcome back, {{ current_user.first_name }}!</div>
  </div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">

    <!-- Active Subjects -->
    <div class="bg-green-600 text-white rounded-lg shadow-lg p-6">
      <div class="flex justify-between items-center">
        <div>
          <p class="text-green-100 text-sm font-medium">Active Subjects</p>
          <p class="text-3xl font-bold">{{ active_subjects_count }}</p>
        </div>
        <div class="bg-green-500 rounded-full p-3">
          <i class="fas fa-book text-2xl"></i>
        </div>
      </div>
    </div>

    <!-- Completed Subjects -->
    <div class="bg-purple-500 text-white rounded-lg shadow-lg p-6">
      <div class="flex justify-between items-center">
        <div>
          <p class="text-purple-100 text-sm font-medium">Completed Subjects</p>
          <p class="text-3xl font-bold">{{ completed_subjects_count }}</p>
        </div>
        <div class="bg-purple-400 rounded-full p-3">
          <i class="fas fa-play text-2xl"></i>
        </div>
      </div>
    </div>

    <!-- Pending Subjects -->
    <div class="bg-yellow-500 text-white rounded-lg shadow-lg p-6">
      <div class="flex justify-between items-center">
        <div>
          <p class="text-yellow-100 text-sm font-medium">Pending Subjects</p>
          <p class="text-3xl font-bold">{{ pending_subjects_count }}</p>
        </div>
        <div class="bg-yellow-400 rounded-full p-3">
          <i class="fas fa-play text-2xl"></i>
        </div>
      </div>
    </div>

    <!-- Today's Total Study Time -->
    <div class="bg-blue-600 text-white rounded-lg shadow-lg p-6">
      <div class="flex justify-between items-center">
        <div>
          <p class="text-blue-100 text-sm font-medium">Today's Total Study Time</p>
          <p class="text-3xl font-bold">{{ total_scheduled_minutes }} min</p>
        </div>
        <div class="bg-blue-500 rounded-full p-3">
          <i class="fas fa-clock text-2xl"></i>
        </div>
      </div>
    </div>

    
  </div>

  <!-- Main Content Grid -->
  <div class="flex flex-col gap-8 mb-8">
    <!-- Subjects Section -->
    <div class="bg-white rounded-lg shadow-lg p-6">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-xl font-semibold text-gray-900">My Subjects</h2>
        <button id="openAddSubject" class="bg-green-600 text-white px-3 py-2 rounded text-sm hover:bg-green-700">
          <i class="fas fa-plus mr-1"></i>Create Subject
        </button>
      </div>
      <div class="space-y-4">
        {% for subject in subjects %}
          <div class="py-2 border-b subject-card " id="subject-{{ subject.id }}">
            <div class="flex items-center justify-between">
              <div class="flex items-center space-x-3">
                <button class="w-6 h-6 flex items-center justify-center text-gray-600 hover:text-gray-900" aria-label="Toggle topics" onclick="toggleTopics({{ subject.id }})">
                  <i id="chev-{{ subject.id }}" class="fas fa-chevron-right"></i>
                </button>
                <span class="cursor-pointer font-bold px-3 py-1 rounded flex items-center" onclick="toggleTopics({{ subject.id }})">
                  {{ subject.name }}
                </span>
                <span class="text-xs text-gray-500">({{ subject.start_time_ampm }} - {{ subject.end_time_ampm }})</span>
              </div>
              <div class="flex items-center  space-x-2">
                <button class="bg-green-600 text-white px-2 py-1 rounded text-xs" title="Finish" onclick="completeSubject(this, {{ subject.id }})">Finish</button>
                <button class="bg-blue-500 text-white px-2 py-1 rounded text-xs" onclick='openEditSubject({{ subject.id }}, {{ subject.name|tojson }})'><i class="fas fa-edit"></i></button>
                <button class="bg-red-500 text-white px-2 py-1 rounded text-xs delete-subject-btn" data-subject-id="{{ subject.id }}"><i class="fas fa-trash"></i></button>
              </div>
            </div>
            <div id="topics-{{ subject.id }}" class="hidden ml-9 mt-2">
              <ul class="space-y-2 mb-3" id="topic-list-{{ subject.id }}">
                {% for topic in subject.topics %}
                  <li class="flex justify-between items-center bg-gray-50 rounded px-3 py-2">
                    <span class="flex items-center topic-name" data-topic-id="{{ topic.id }}"><i class="fas fa-circle text-gray-400 text-[8px] mr-2"></i>{{ topic.name }}</span>
                    <div class="flex items-center space-x-2">
                      <button class="bg-blue-500 text-white px-2 py-1 rounded text-xs edit-topic-btn" data-topic-id="{{ topic.id }}" data-topic-name="{{ topic.name }}"><i class="fas fa-edit"></i></button>
                      <button class="bg-red-400 text-white px-2 py-1 rounded text-xs delete-topic-btn" data-topic-id="{{ topic.id }}"><i class="fas fa-trash"></i></button>
                    </div>
                  </li>
                {% endfor %}
              </ul>
              <div class="flex items-center space-x-2">
                <input type="text" placeholder="Add a topic" class="border rounded px-3 py-2 flex-1" id="new-topic-input-{{ subject.id }}">
                <button class="bg-green-600 text-white px-3 py-2 rounded text-sm" onclick="submitNewTopic({{ subject.id }})"><i class="fas fa-plus mr-1"></i></button>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    
  </div>

  <!-- Quick Actions -->
  <div class="bg-white rounded-lg shadow-lg">
    <div class="px-6 py-4 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-gray-900"><i class="fas fa-bolt mr-2 text-blue-600"></i>Quick Actions</h2>
    </div>
    <div class="p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <button class="flex items-center justify-center px-4 py-3 border border-blue-600 text-blue-600 rounded-lg hover:bg-blue-600 hover:text-white transition duration-200"><i class="fas fa-play mr-2"></i>Start Study Session</button>
        <button class="flex items-center justify-center px-4 py-3 border border-green-600 text-green-600 rounded-lg hover:bg-green-600 hover:text-white transition duration-200"><i class="fas fa-calendar-plus mr-2"></i>Schedule Study Time</button>
        <button class="flex items-center justify-center px-4 py-3 border border-yellow-600 text-yellow-600 rounded-lg hover:bg-yellow-600 hover:text-white transition duration-200"><i class="fas fa-exam mr-2"></i>Enter Exam Mode</button>
        <button class="flex items-center justify-center px-4 py-3 border border-blue-500 text-blue-500 rounded-lg hover:bg-blue-500 hover:text-white transition duration-200"><i class="fas fa-chart-line mr-2"></i>View Progress</button>
      </div>
    </div>
  </div>

  <!-- Add Subject Modal -->
  <div id="addSubjectModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-md p-6">
      <h3 class="text-xl font-semibold mb-4">Add Subject</h3>
      <form id="addSubjectForm">
        <div class="mb-4">
          <label class="block text-gray-700 mb-1">Subject Name</label>
          <input type="text" name="name" class="w-full border rounded px-3 py-2" required>
        </div>
        <div class="mb-4">
          <label class="block text-gray-700 mb-1">Start Time</label>
          <div class="flex space-x-2">
            {% set _h12 = (current_hour % 12) %}
            {% if _h12 == 0 %}{% set _h12 = 12 %}{% endif %}
            <select name="start_hour_12" class="border rounded px-2 py-1" required>
              {% for h in range(1,13) %}
                <option value="{{ h }}" {% if h == _h12 %}selected{% endif %}>{{ "%02d"|format(h) }}</option>
              {% endfor %}
            </select>
            <select name="start_minute" class="border rounded px-2 py-1" required>
              {% for m in range(0,60,5) %}
                <option value="{{ m }}" {% if m == (current_minute // 5 * 5) %}selected{% endif %}>{{ "%02d"|format(m) }}</option>
              {% endfor %}
            </select>
            <select name="start_ampm" class="border rounded px-2 py-1" required>
              <option value="AM" {% if current_hour < 12 %}selected{% endif %}>AM</option>
              <option value="PM" {% if current_hour >= 12 %}selected{% endif %}>PM</option>
            </select>
          </div>
        </div>
        <div class="mb-4">
          <label class="block text-gray-700 mb-1">End Time</label>
          <div class="flex space-x-2">
            <select name="end_hour_12" class="border rounded px-2 py-1" required>
              {% for h in range(1,13) %}
                <option value="{{ h }}">{{ "%02d"|format(h) }}</option>
              {% endfor %}
            </select>
            <select name="end_minute" class="border rounded px-2 py-1" required>
              {% for m in range(0,60,5) %}
                <option value="{{ m }}">{{ "%02d"|format(m) }}</option>
              {% endfor %}
            </select>
            <select name="end_ampm" class="border rounded px-2 py-1" required>
              <option value="AM">AM</option>
              <option value="PM" selected>PM</option>
            </select>
          </div>
        </div>
        <div class="flex justify-end space-x-2">
          <button type="button" id="cancelAddSubject" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Cancel</button>
          <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Create</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modals -->
  <div id="editSubjectModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-sm p-6">
      <h3 class="text-lg font-semibold mb-4">Edit Subject</h3>
      <form id="editSubjectForm">
        <input type="hidden" name="subject_id" id="editSubjectId">
        <div class="mb-4">
          <label class="block text-gray-700 mb-1">Name</label>
          <input type="text" name="name" id="editSubjectName" class="w-full border rounded px-3 py-2" required>
        </div>
        
        <div class="flex justify-end space-x-2">
          <button type="button" onclick="closeEditSubject()" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Cancel</button>
          <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Save</button>
        </div>
      </form>
    </div>
  </div>

  

  <div id="addTopicModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-sm p-6">
      <h3 class="text-lg font-semibold mb-4">Add Topic</h3>
      <form id="addTopicForm">
        <input type="hidden" name="subject_id" id="addTopicSubjectId">
        <div class="mb-4">
          <label class="block text-gray-700 mb-1">Topic Name</label>
          <input type="text" name="name" id="addTopicName" class="w-full border rounded px-3 py-2" required>
        </div>
        <div class="flex justify-end space-x-2">
          <button type="button" onclick="closeAddTopic()" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Cancel</button>
          <button type="submit" class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">Add</button>
        </div>
      </form>
    </div>
  </div>

  <div id="editTopicModal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg shadow-lg w-full max-w-sm p-6">
      <h3 class="text-lg font-semibold mb-4">Edit Topic</h3>
      <form id="editTopicForm">
        <input type="hidden" name="topic_id" id="editTopicId">
        <div class="mb-4">
          <label class="block text-gray-700 mb-1">Topic Name</label>
          <input type="text" name="name" id="editTopicName" class="w-full border rounded px-3 py-2" required>
        </div>
        <div class="flex justify-end space-x-2">
          <button type="button" id="cancelEditTopic" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Cancel</button>
          <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">Save</button>
        </div>
      </form>
    </div>
  </div>

  <audio id="reminderAudio" src="{{ url_for('main.get_reminder_song') }}" preload="auto"></audio>

  <script>
    // Modal open/close
    document.getElementById('openAddSubject').onclick = function () {
      document.getElementById('addSubjectModal').classList.remove('hidden')
    }
    const openAddSubjectModalBtn = document.getElementById('openAddSubjectModal')
    if (openAddSubjectModalBtn) {
      openAddSubjectModalBtn.onclick = function () {
        document.getElementById('addSubjectModal').classList.remove('hidden')
      }
    }
    document.getElementById('cancelAddSubject').onclick = function () {
      document.getElementById('addSubjectModal').classList.add('hidden')
    }
    
    // Build subjects array with end times
    const subjects = [
      {% for subject in subjects %}
        {
          end_hour: {{ subject.end_hour }},
          end_minute: {{ subject.end_minute }},
          id: {{ subject.id }},
          finished_today: {{ (subject.id in finished_subject_ids)|tojson }},
          finished_at: {{ (subject.finished_at.isoformat() + 'Z')|tojson if subject.finished_at else 'null' }}
        },
      {% endfor %}
    ];

    let reminderStopTimer = null;
    function playReminderSong() {
      const audio = document.getElementById('reminderAudio');
      console.log("Playing reminder song...");
      if (audio) {
        audio.currentTime = 0;
        audio.play().then(() => {
          if (reminderStopTimer) clearTimeout(reminderStopTimer);
          reminderStopTimer = setTimeout(() => {
            audio.pause();
            audio.currentTime = 0;
            reminderStopTimer = null;
          }, {{ current_user.reminder_song_seconds or 10 }} * 1000);
        }).catch(() => {
          // Autoplay blocked, prompt user to click to play
          if (confirm("It's your study end time! Click OK to play your reminder song.")) {
            audio.play();
            if (reminderStopTimer) clearTimeout(reminderStopTimer);
            reminderStopTimer = setTimeout(() => {
              audio.pause();
              audio.currentTime = 0;
              reminderStopTimer = null;
            }, {{ current_user.reminder_song_seconds or 10 }} * 1000);
          }
        });
      } else {
        alert("It's your study end time!");
      }
    }

    function stopReminderSong() {
      const audio = document.getElementById('reminderAudio');
      if (reminderStopTimer) {
        clearTimeout(reminderStopTimer);
        reminderStopTimer = null;
      }
      if (audio) {
        try { audio.pause(); } catch (e) {}
        audio.currentTime = 0;
      }
    }

    function checkReminder() {
      const now = new Date();
      const currentHour = now.getHours();
      const currentMinute = now.getMinutes();
      subjects.forEach(sub => {
        if (!sub.finished_today && currentHour === sub.end_hour && currentMinute === sub.end_minute) {
          playReminderSong();
        }
        
      });
    }

    // Only run if there are subjects
    if (subjects.length > 0) {
      setInterval(checkReminder, 60000); // every minute
      checkReminder(); // on page load
    }

    // AJAX form submit
    document.getElementById('addSubjectForm').onsubmit = async function (e) {
      e.preventDefault()
      const form = e.target
      // Convert 12-hour inputs to 24-hour for API
      function to24(h12, ampm) {
        let h = parseInt(h12, 10);
        if (ampm === 'AM') {
          return h % 12; // 12 AM -> 0
        } else {
          return (h % 12) + 12; // 12 PM -> 12
        }
      }
      const startHour24 = to24(form.start_hour_12.value, form.start_ampm.value);
      const endHour24 = to24(form.end_hour_12.value, form.end_ampm.value);
      const data = {
        name: form.name.value,
        start_hour: startHour24,
        start_minute: form.start_minute.value,
        end_hour: endHour24,
        end_minute: form.end_minute.value,
        // Also send original fields for potential future parsing on backend
        start_hour_12: form.start_hour_12.value,
        start_ampm: form.start_ampm.value,
        end_hour_12: form.end_hour_12.value,
        end_ampm: form.end_ampm.value
      }
      const res = await fetch('/add_subject', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      if (res.ok) {
        document.getElementById('addSubjectModal').classList.add('hidden')
        location.reload() // Reload to show new subject
      } else {
        alert('Failed to add subject')
      }
    }
    
    function toggleTopics(subjectId) {
      const el = document.getElementById('topics-' + subjectId);
      const chev = document.getElementById('chev-' + subjectId);
      const willShow = el.classList.contains('hidden');
      document.querySelectorAll('[id^="topics-"]').forEach(e => e.classList.add('hidden'));
      document.querySelectorAll('[id^="chev-"]').forEach(c => {
        c.classList.remove('fa-chevron-down');
        c.classList.add('fa-chevron-right');
      });
      if (willShow) {
        el.classList.remove('hidden');
        if (chev) {
          chev.classList.remove('fa-chevron-right');
          chev.classList.add('fa-chevron-down');
        }
      } else {
        el.classList.add('hidden');
        if (chev) {
          chev.classList.remove('fa-chevron-down');
          chev.classList.add('fa-chevron-right');
        }
      }
    }
    async function completeSubject(btnEl, subjectId) {
      try {
        if (btnEl) btnEl.disabled = true;
        // Immediately stop any currently playing reminder
        stopReminderSong();
        const res = await fetch(`/subject/${subjectId}/complete`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'}
        });
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        // Visual feedback: briefly flash the subject card border green
        const card = document.getElementById('subject-' + subjectId);
        if (card) {
          card.classList.add('ring-2','ring-green-400');
          setTimeout(() => card.classList.remove('ring-2','ring-green-400'), 1200);
        }
        // Mark finished_today to suppress ringtone at end time
        const sub = subjects.find(s => s && String(s.id) === String(subjectId));
        if (sub) {
          sub.finished_today = true;
          sub.finished_at = data.completed_at || new Date().toISOString();
        }
      } catch (e) {
        alert('Could not mark as completed');
      } finally {
        if (btnEl) btnEl.disabled = false;
      }
    }
    async function submitNewTopic(subjectId) {
      const input = document.getElementById('new-topic-input-' + subjectId);
      const name = (input.value || '').trim();
      if (!name) return;
      const res = await fetch(`/subject/${subjectId}/add_topic`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name})
      });
      if (res.ok) {
        const data = await res.json();
        const ul = document.getElementById('topic-list-' + subjectId);
        const li = document.createElement('li');
        li.className = 'flex justify-between items-center bg-gray-50 rounded px-3 py-2';
        li.innerHTML = `<span class="flex items-center"><i class=\"fas fa-circle text-gray-400 text-[8px] mr-2\"></i>${data.topic.name}</span><button class=\"bg-red-400 text-white px-2 py-1 rounded text-xs delete-topic-btn\" data-topic-id=\"${data.topic.id}\"><i class=\"fas fa-trash mr-1\"></i>Delete</button>`;
        ul.appendChild(li);
        input.value = '';
        // Re-bind delete handler for the new button
        li.querySelector('.delete-topic-btn').onclick = deleteTopicHandler;
      }
    }

    window.openExtraTime = function(id) {
      document.getElementById('extraTimeSubjectId').value = id;
      document.getElementById('extraTimeModal').classList.remove('hidden');
    }
    window.closeExtraTime = function() {
      document.getElementById('extraTimeModal').classList.add('hidden');
    }
    // Extra time removed

    window.openEditSubject = function(id, name) {
      console.log('openEditSubject', id, name)
      document.getElementById('editSubjectId').value = id;
      document.getElementById('editSubjectName').value = name;
      document.getElementById('editSubjectModal').classList.remove('hidden');
    }
    function closeEditSubject() {
      document.getElementById('editSubjectModal').classList.add('hidden');
    }
    document.getElementById('editSubjectForm').onsubmit = async function(e) {
      e.preventDefault();
      const id = document.getElementById('editSubjectId').value;
      const name = document.getElementById('editSubjectName').value;
      const res = await fetch(`/subject/${id}/edit`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name})
      });
      if (res.ok) {
        location.reload();
      }
    };

    

    function openAddTopic(subjectId) {
      document.getElementById('addTopicSubjectId').value = subjectId;
      document.getElementById('addTopicModal').classList.remove('hidden');
    }
    function closeAddTopic() {
      document.getElementById('addTopicModal').classList.add('hidden');
    }
    document.getElementById('addTopicForm').onsubmit = async function(e) {
      e.preventDefault();
      const subjectId = document.getElementById('addTopicSubjectId').value;
      const name = document.getElementById('addTopicName').value;
      const res = await fetch(`/subject/${subjectId}/add_topic`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({name})
      });
      if (res.ok) {
        location.reload();
      }
    };

    function bindDeleteSubjectHandlers() {
      document.querySelectorAll('.delete-subject-btn').forEach(btn => {
        btn.onclick = async function(e) {
          e.preventDefault();
          e.stopPropagation();
          if (!confirm('Are you sure you want to delete this subject and all its topics?')) return;
          const subjectId = btn.getAttribute('data-subject-id');
          try {
            const res = await fetch(`/delete_subject/${subjectId}`, {
              method: 'POST',
              headers: {'X-Requested-With': 'XMLHttpRequest'}
            });
            if (!res.ok) {
              const text = await res.text();
              alert('Failed to delete subject. Status ' + res.status + ': ' + text);
              return;
            }
            const result = await res.json().catch(() => ({ success: false }));
            if (result && result.success) {
              const subjectEl = document.getElementById('subject-' + subjectId) || btn.closest('.subject-card');
              if (subjectEl) subjectEl.remove();
              const topicsEl = document.getElementById('topics-' + subjectId);
              if (topicsEl) topicsEl.remove();
            } else {
              alert('Failed to delete subject: ' + ((result && result.error) || 'Unknown error'));
            }
          } catch (err) {
            alert('Network error deleting subject: ' + err);
          }
        };
      });
    }
    bindDeleteSubjectHandlers();
    function deleteTopicHandler(e) {
      const btn = e.currentTarget;
      (async () => {
        if (!confirm('Are you sure you want to delete this topic?')) return;
        const topicId = btn.getAttribute('data-topic-id');
        const res = await fetch(`/delete_topic/${topicId}`, {
          method: 'POST',
          headers: {'X-Requested-With': 'XMLHttpRequest'}
        });
        const result = await res.json();
        if (result.success) {
          btn.closest('li').remove();
        } else {
          alert('Failed to delete topic: ' + (result.error || 'Unknown error'));
        }
      })();
    }
    document.querySelectorAll('.delete-topic-btn').forEach(btn => {
      btn.onclick = deleteTopicHandler;
    });

    function openEditTopic(topicId, topicName) {
      document.getElementById('editTopicId').value = topicId;
      document.getElementById('editTopicName').value = topicName;
      document.getElementById('editTopicModal').classList.remove('hidden');
    }
    function closeEditTopic() {
      document.getElementById('editTopicModal').classList.add('hidden');
    }
    document.getElementById('cancelEditTopic').onclick = closeEditTopic;

    function bindEditTopicHandlers() {
      document.querySelectorAll('.edit-topic-btn').forEach(btn => {
        btn.onclick = function() {
          const id = btn.getAttribute('data-topic-id');
          const name = btn.getAttribute('data-topic-name');
          openEditTopic(id, name);
        }
      });
    }
    bindEditTopicHandlers();

    document.getElementById('editTopicForm').onsubmit = async function(e) {
      e.preventDefault();
      const id = document.getElementById('editTopicId').value;
      const name = document.getElementById('editTopicName').value.trim();
      if (!name) return;
      const res = await fetch(`/topic/${id}/edit`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ name })
      });
      const result = await res.json();
      if (res.ok && result.success) {
        // Update the displayed name without reload
        const nameEls = document.querySelectorAll(`.topic-name[data-topic-id="${id}"]`);
        nameEls.forEach(el => {
          el.innerHTML = `<i class=\"fas fa-circle text-gray-400 text-[8px] mr-2\"></i>${name}`;
        });
        // Update data-topic-name on edit buttons
        document.querySelectorAll(`.edit-topic-btn[data-topic-id="${id}"]`).forEach(btn => {
          btn.setAttribute('data-topic-name', name);
        });
        closeEditTopic();
      } else {
        alert('Failed to update topic');
      }
    }
  </script>
{% endblock %}
